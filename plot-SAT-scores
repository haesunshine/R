# Clear the console
cat("\014")
# Remove every object in the environment
rm(list = ls())

lib <- c("extrafont", "reshape", "dplyr", "ggplot2", "grid", "gridExtra", "scales", "RColorBrewer")
#sapply(lib, function(x) install.packages(x))
sapply(lib, function(x) require(x, character.only = TRUE))
#font_import(pattern = "[A/a]rial")
loadfonts (device = "win")

setwd("C:/Users/HSeok/Downloads")

# load data
sat <- read.csv("sat_data.csv", as.is = TRUE)

# grab only means for math and reading and clean up the numbers

sat <- sat[,c(1, 4, 6)]
names(sat) <- c("group", "Mean Reading Score", "Mean Math Score")

# by income group
data <- sat[c(23:32),]

# by parental education; vetoes by Greg
#by_par <- sat[c(36:40),]

# change the factor ordering for proper stacking  
data$group <- factor(data$group, levels = (data$group[order(rownames(data))]))

# clean/melt to long form
data.m <- melt(data, id = "group")
data.m$value <- as.numeric(as.character(data.m$value))

# regular bar graph, unstacked

p <-  ggplot(data.m, aes(x = group, y = value)) + 
      geom_bar(stat = 'identity', position = 'dodge', aes(fill = variable, group = factor(variable))) +
      theme_bw() +
      theme(
         axis.line = element_line(size = 0.5, colour = "black"),
         panel.grid.major = element_blank(), 
         panel.grid.minor = element_blank(),
         panel.border = element_blank()) +
         theme(axis.title.x = element_blank(),
         axis.title.y = element_blank(),
         axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
         axis.text.y = element_text(size = 10)) +
         scale_fill_manual(name = "SAT Scores by Family-Income Bracket",
                           values = c("#FC8D59", "#FFFFBF")) +
         scale_y_continuous(expand = c(0,0), limits = c(0, 600), breaks = seq(0, 600, 100)) +
         theme(legend.position = "bottom",
               legend.text = element_text(size = 10)) +
         theme(text = element_text(family = "Arial"))

# add titles

plot.title = "Wealthier Students Get Higher SAT Scores\n"

p1 <- p + 
      theme(plot.title = element_text(size = 18,
                                    face = "bold"),
           text = element_text(family = "Arial")) +   
      ggtitle(plot.title)
    
#plot.title = "Wiser Parents, Wiser Children?"
#plot.subtitle = 'SAT Scores by Highest Level of Parental Education'    

#plot_edu <- plot_edu + 
 #           theme(plot.title = element_text(lineheight = .8, face = "bold")) +
 #           ggtitle(bquote(atop(.(plot.title), atop(italic(.(plot.subtitle)), "")))) 

# add source line

p1 <- arrangeGrob(p1, sub = textGrob("Source: College Board, Total Group Profile Report 2013\n", x = 0, hjust = 0, gp = gpar(fontsize = 9)))


# print

pdf("21. SAT Scores.pdf", onefile = TRUE, paper = "a4r")
print(p1)
dev.off()
